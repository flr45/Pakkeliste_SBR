{% extends "base.html" %}
{% block content %}
<div class="row between vhead">
  <h1>{{ v.name }}</h1>
  <a class="btn" href="/vehicle/{{ v.id }}/export">EksportÃ©r CSV</a>
</div>

<div class="card">
  <label class="row between wrap">
    <span>Beskrivelse</span>
    {% if request.session.get('user') %}
    <button id="saveDesc" class="btn">Gem</button>
    {% endif %}
  </label>
  <textarea id="desc" rows="3" placeholder="Skriv en kort tekst om kÃ¸retÃ¸jet...">{{ v.description }}</textarea>

  {% if request.session.get('user') %}
  <div class="row gap">
    <form id="docForm" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button class="btn" type="submit">Upload dokument</button>
    </form>
  </div>
  {% endif %}

  {% if v.docs and v.docs|length %}
  <ul class="docs">
    {% for d in v.docs %}
      <li><a href="{{ d.path }}" target="_blank">ðŸ“„ {{ d.filename }}</a></li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<input id="localSearch" class="search" placeholder="SÃ¸g i dette kÃ¸retÃ¸j...">

{% if request.session.get('user') %}
<div class="row gap">
  <form id="newPlaceForm" class="inline-form">
    <input name="name" placeholder="Nyt rum/kasse..." required>
    <button class="btn" type="submit">TilfÃ¸j rum</button>
  </form>
</div>
{% endif %}

<div id="places">
  {% for p in v.places %}
  <details class="place" id="place-{{ p.id }}">
    <summary>
      <b class="pname" {% if request.session.get('user') %}contenteditable="true" data-pid="{{ p.id }}"{% endif %}>{{ p.name }}</b>
      <span class="badge">{{ p.items | length }} enheder</span>
    </summary>
    {% if request.session.get('user') %}
    <form class="inline-form small addItemForm" data-pid="{{ p.id }}">
      <input name="name" placeholder="Nyt udstyr..." required>
      <input name="quantity" type="number" min="1" value="1" style="max-width:80px">
      <input name="note" placeholder="Note (valgfri)">
      <button class="btn" type="submit">TilfÃ¸j</button>
    </form>
    {% endif %}
    <ul class="items">
      {% for it in p.items %}
      <li class="item" data-name="{{ it.name | lower }} {{ it.note | lower }}">
        <div class="row between">
          <div class="wrap">
            <b>{{ it.name }}</b>
            {% if it.note %}<span class="muted">â€“ {{ it.note }}</span>{% endif %}
            {% if it.photo_path %} <a href="{{ it.photo_path }}" target="_blank">ðŸ“·</a>{% endif %}
          </div>
          <div class="row gap">
            <span class="qty">x{{ it.quantity }}</span>
            {% if request.session.get('user') %}
            <label class="btn small">
              ðŸ“·
              <input type="file" class="hidden uploadPhoto" data-itemid="{{ it.id }}">
            </label>
            {% endif %}
          </div>
        </div>
      </li>
      {% endfor %}
    </ul>
  </details>
  {% else %}
  <p>Ingen rum/kasser endnu.</p>
  {% endfor %}
</div>

<script>
const vid = {{ v.id }};

// Lokal sÃ¸gning
document.getElementById('localSearch').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  document.querySelectorAll('.place').forEach(place => {
    let any = false;
    place.querySelectorAll('.item').forEach(li => {
      const hit = li.dataset.name.includes(q);
      li.style.display = hit ? '' : 'none';
      if (hit) any = true;
    });
    place.style.display = (any || q==='') ? '' : 'none';
    if (q!=='' && any) place.open = true;
  });
});

// Gem beskrivelse
const saveDesc = document.getElementById('saveDesc');
if (saveDesc){
  saveDesc.addEventListener('click', async (e)=>{
    e.preventDefault();
    const fd = new FormData();
    fd.append('description', document.getElementById('desc').value);
    const r = await fetch(`/vehicle/${vid}/description`, {method:'POST', body:fd});
    if(r.ok){ saveDesc.textContent='Gemt âœ“'; setTimeout(()=>saveDesc.textContent='Gem',1000); }
  });
}

// Upload dokument
const docForm = document.getElementById('docForm');
if (docForm){
  docForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(docForm);
    const r = await fetch(`/vehicle/${vid}/docs`, {method:'POST', body:fd});
    if(r.ok){ location.reload(); }
  });
}

// Opret rum
const newPlaceForm = document.getElementById('newPlaceForm');
if (newPlaceForm){
  newPlaceForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(newPlaceForm);
    const r = await fetch(`/vehicle/${vid}/places/new`, {method:'POST', body:fd});
    if(r.ok){ location.reload(); }
  });
}

// Rename rum (contenteditable)
document.querySelectorAll('.pname[contenteditable="true"]').forEach(el=>{
  el.addEventListener('blur', async ()=>{
    const pid = el.dataset.pid;
    const fd = new FormData();
    fd.append('name', el.textContent.trim());
    await fetch(`/place/${pid}/rename`, {method:'POST', body:fd});
  });
});

// TilfÃ¸j item i rum
document.querySelectorAll('.addItemForm').forEach(form=>{
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const pid = form.dataset.pid;
    const fd = new FormData(form);
    const r = await fetch(`/place/${pid}/items/new`, {method:'POST', body:fd});
    if(r.ok){ location.reload(); }
  });
});

// Upload foto til item
document.querySelectorAll('.uploadPhoto').forEach(inp=>{
  inp.addEventListener('change', async ()=>{
    const fd = new FormData();
    const file = inp.files[0];
    if(!file) return;
    fd.append('file', file);
    const r = await fetch(`/item/${inp.dataset.itemid}/photo`, {method:'POST', body:fd});
    if(r.ok){ location.reload(); }
  });
});
</script>
{% endblock %}
